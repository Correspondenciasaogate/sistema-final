let html5QrCode;

async function iniciarLeitor() {
    const areaScanner = document.getElementById('area-scanner');
    areaScanner.style.display = 'block';

    // Verifica se o site está em HTTPS (obrigatório para câmera no celular)
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        alert("Erro: A câmera só funciona em sites seguros (HTTPS).");
        areaScanner.style.display = 'none';
        return;
    }

    // Instancia o leitor
    html5QrCode = new Html5Qrcode("reader");

    const config = { 
        fps: 10, 
        qrbox: { width: 280, height: 150 }, // Tamanho ideal para código de barras
        aspectRatio: 1.0 
    };

    try {
        await html5QrCode.start(
            { facingMode: "environment" }, // Força a câmera traseira
            config,
            (decodedText) => {
                document.getElementById('notaFiscal').value = decodedText;
                pararLeitor();
                if (navigator.vibrate) navigator.vibrate(100); // Vibra ao ler
            },
            (errorMessage) => { 
                // Apenas ignora erros de busca (quando não detecta código na imagem)
            }
        );
    } catch (err) {
        console.error("Erro ao iniciar leitor:", err);
        alert("Câmera bloqueada ou não encontrada. Verifique as permissões do seu navegador.");
        areaScanner.style.display = 'none';
    }
}

function pararLeitor() {
    if (html5QrCode && html5QrCode.isScanning) {
        html5QrCode.stop().then(() => {
            document.getElementById('area-scanner').style.display = 'none';
            html5QrCode.clear();
        }).catch(err => {
            console.log("Erro ao parar:", err);
            document.getElementById('area-scanner').style.display = 'none';
        });
    } else {
        document.getElementById('area-scanner').style.display = 'none';
    }
}
