<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Gate - Oficial</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        /* CSS B츼SICO PARA FUNCIONAMENTO */
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding: 10px; }
        .container { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
        input, select, button { width: 100%; padding: 12px; margin: 5px 0; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; font-size: 16px; }
        button { cursor: pointer; font-weight: bold; border: none; }
        .btn-principal { background: #15803d; color: white; }
        .btn-camera { background: #1e293b; color: white; }
        .btn-importar { background: #0ea5e9; color: white; }
        #reader { width: 100%; border-radius: 8px; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 14px; }
        th { background: #f8f9fa; }
        .status-aguardando { color: #f59e0b; font-weight: bold; }
        .status-retirado { color: #15803d; }
    </style>
</head>
<body>

<div class="container">
    <h2>游닍 Novo Recebimento</h2>
    
    <button type="button" class="btn-camera" onclick="iniciarLeitor()">游닝 Abrir C칙mera (QR/Barra)</button>
    <div id="reader" style="display:none"></div>
    <button id="btnFecharCam" style="display:none; background:red; color:white;" onclick="pararLeitor()">Fechar C칙mera</button>

    <form id="formEncomenda">
        <input type="text" id="notaFiscal" placeholder="Nota Fiscal" required>
        
        <div style="display: flex; gap: 5px;">
            <select id="torre" style="flex: 1;" required onchange="buscarContato()">
                <option value="">Torre</option>
                <option value="Gate">Gate</option>
                <option value="Way">Way</option>
            </select>
            <input type="text" id="sala" placeholder="Sala" style="flex: 1;" required oninput="buscarContato()">
        </div>

        <input type="text" id="destinatario" placeholder="Nome do Destinat치rio" required>
        <input type="text" id="telefone" placeholder="Telefone (Autom치tico)" readonly style="background:#e2e8f0">

        <button type="submit" class="btn-principal">Salvar Mercadoria</button>
    </form>
</div>

<div class="container">
    <h3>游댌 Ferramentas</h3>
    <div style="display: flex; gap: 10px;">
        <button class="btn-importar" onclick="document.getElementById('inputArquivo').click()">游닌 Importar Backup</button>
        <input type="file" id="inputArquivo" style="display:none" accept=".csv" onchange="importarCSV(event)">
        <button style="background:#64748b; color:white;" onclick="exportarCSV()">游늵 Exportar</button>
    </div>
</div>

<div class="container" style="overflow-x: auto;">
    <h3>游늶 Registros</h3>
    <table id="tabela">
        <thead>
            <tr>
                <th>Data</th>
                <th>NF</th>
                <th>Sala</th>
                <th>Nome</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="lista"></tbody>
    </table>
</div>

<script>
    // --- COLE SUA LISTA DE MORADORES AQUI ---
    const agendaMoradores = {
        "Gate101": "11999999999",
        "Gate102": "11888888888",
        "Way101": "11777777777",
        // ... continue colando sua lista aqui
    };

    let encomendas = JSON.parse(localStorage.getItem('banco_gate')) || [];
    let html5QrCode;

    // FUN칂츾O QUE PUXA O TELEFONE (IGUAL ANTES)
    function buscarContato() {
        const torre = document.getElementById('torre').value;
        const sala = document.getElementById('sala').value.trim();
        const campoTel = document.getElementById('telefone');
        const chave = torre + sala;

        if (agendaMoradores[chave]) {
            campoTel.value = agendaMoradores[chave];
            campoTel.style.background = "#dcfce7";
        } else {
            campoTel.value = "";
            campoTel.style.background = "#e2e8f0";
        }
    }

    // FUN칂츾O DA C츽MERA
    function iniciarLeitor() {
        document.getElementById('reader').style.display = 'block';
        document.getElementById('btnFecharCam').style.display = 'block';
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            (text) => {
                document.getElementById('notaFiscal').value = text;
                pararLeitor();
            }
        ).catch(err => alert("Erro na c칙mera. Verifique a permiss칚o."));
    }

    function pararLeitor() {
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                document.getElementById('reader').style.display = 'none';
                document.getElementById('btnFecharCam').style.display = 'none';
            });
        }
    }

    // SALVAR
    document.getElementById('formEncomenda').onsubmit = (e) => {
        e.preventDefault();
        const nova = {
            data: new Date().toLocaleDateString('pt-BR'),
            nf: document.getElementById('notaFiscal').value,
            torre: document.getElementById('torre').value,
            sala: document.getElementById('sala').value,
            nome: document.getElementById('destinatario').value,
            status: 'Aguardando retirada'
        };
        encomendas.push(nova);
        localStorage.setItem('banco_gate', JSON.stringify(encomendas));
        e.target.reset();
        buscarContato();
        render();
    };

    function render() {
        const lista = document.getElementById('lista');
        lista.innerHTML = encomendas.map(enc => `
            <tr>
                <td>${enc.data}</td>
                <td>${enc.nf}</td>
                <td>${enc.torre} ${enc.sala}</td>
                <td>${enc.nome}</td>
                <td class="${enc.status === 'Retirado' ? 'status-retirado' : 'status-aguardando'}">${enc.status}</td>
            </tr>
        `).reverse().join('');
    }

    // IMPORTAR BACKUP (PARA RECUPERAR O QUE VOC칅 EXPORTOU)
    function importarCSV(event) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const linhas = e.target.result.split('\n');
            for (let i = 1; i < linhas.length; i++) {
                const col = linhas[i].split(';');
                if (col.length >= 4) {
                    encomendas.push({
                        data: col[0], nf: col[1], torre: col[2], sala: col[3], nome: col[4], status: col[5] || 'Aguardando retirada'
                    });
                }
            }
            localStorage.setItem('banco_gate', JSON.stringify(encomendas));
            render();
            alert("Dados recuperados!");
        };
        reader.readAsText(event.target.files[0]);
    }

    function exportarCSV() {
        let csv = "\ufeffData;NF;Torre;Sala;Nome;Status\n";
        encomendas.forEach(e => {
            csv += `${e.data};${e.nf};${e.torre};${e.sala};${e.nome};${e.status}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "encomendas_gate.csv";
        link.click();
    }

    render();
</script>

</body>
</html>
